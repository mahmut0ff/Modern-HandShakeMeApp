═══════════════════════════════════════════════════════════════════
  LAMBDA SRC/ DIRECTORY - ПОЛНЫЙ АНАЛИЗ
═══════════════════════════════════════════════════════════════════

Дата: 2026-02-01

═══════════════════════════════════════════════════════════════════

📁 СТРУКТУРА:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

lambda/src/
├── server.js                    # Express + WebSocket сервер
├── middleware/
│   ├── errorHandler.js          # Централизованная обработка ошибок
│   ├── rateLimiter.js           # Rate limiting (in-memory)
│   └── requestLogger.js         # Логирование запросов
├── routes/
│   ├── auth.js                  # ✅ Telegram авторизация (работает)
│   ├── users.js                 # ⚠️ Заглушка
│   ├── orders.js                # ⚠️ Заглушка
│   ├── masters.js               # ⚠️ Заглушка
│   ├── clients.js               # ⚠️ Заглушка
│   ├── applications.js          # ⚠️ Заглушка
│   ├── projects.js              # ⚠️ Заглушка
│   ├── reviews.js               # ⚠️ Заглушка
│   ├── notifications.js         # ⚠️ Заглушка
│   ├── chat.js                  # ⚠️ Заглушка
│   ├── categories.js            # ⚠️ Заглушка
│   ├── services.js              # ⚠️ Заглушка
│   └── bookings.js              # ⚠️ Заглушка
└── utils/
    ├── dynamo.js                # DynamoDB клиент
    └── repositories.js          # UserRepository, ClientProfileRepository

═══════════════════════════════════════════════════════════════════

🔍 ДЕТАЛЬНЫЙ АНАЛИЗ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. SERVER.JS (Express + WebSocket)
   ✅ Хорошо:
      - Express сервер настроен правильно
      - WebSocket сервер работает
      - CORS настроен
      - Helmet для безопасности
      - Compression включен
      - Graceful shutdown
      - Health check endpoint
      - Winston logger
   
   ⚠️ Проблемы:
      - Использует .env.local вместо .env
      - WebSocket логика минимальная (только ping/pong)
      - Нет аутентификации для WebSocket
      - global.broadcastToRoom - плохая практика
      - Hardcoded IP (10.228.141.81)
      - Нет reconnection логики

2. MIDDLEWARE/
   ✅ errorHandler.js:
      - Хорошая централизованная обработка
      - Поддержка Zod, JWT, DB ошибок
      - Логирование
      - Правильные HTTP коды
   
   ⚠️ rateLimiter.js:
      - Использует in-memory (не масштабируется)
      - Redis отключен "for stability" (плохо для production)
      - Нет персистентности
      - Потеряется при рестарте
   
   ❓ requestLogger.js:
      - Не прочитан, но используется

3. ROUTES/
   ✅ auth.js:
      - Telegram login/register работает
      - JWT токены генерируются
      - Zod валидация
      - Логирование
      - Правильные HTTP коды
   
   ⚠️ Проблемы auth.js:
      - Hardcoded auth URL (exp://10.228.141.81:8081)
      - Нет rate limiting на auth endpoints
      - Нет проверки auth_token
      - Logout не инвалидирует токены
      - Нет refresh token rotation
   
   ❌ Остальные routes:
      - Все заглушки ("coming soon")
      - Не реализованы
      - Только возвращают JSON с сообщением

4. UTILS/
   ✅ repositories.js:
      - UserRepository работает
      - ClientProfileRepository работает
      - DynamoDB интеграция
      - UUID генерация
      - GSI индексы настроены
   
   ⚠️ Проблемы:
      - Только 2 репозитория (User, ClientProfile)
      - Нет остальных (Order, Master, etc.)
      - Нет error handling
      - Нет retry логики

═══════════════════════════════════════════════════════════════════

⚠️ КРИТИЧЕСКИЕ ПРОБЛЕМЫ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. ДУБЛИРОВАНИЕ АРХИТЕКТУРЫ ❌
   - lambda/src/ - Express сервер (JavaScript)
   - lambda/core/ - Lambda функции (TypeScript)
   
   ДВЕ РАЗНЫЕ РЕАЛИЗАЦИИ ОДНОГО API!
   
   Проблемы:
   - Разные языки (JS vs TS)
   - Разная логика
   - Разные endpoints
   - Сложность поддержки
   - Риск рассинхронизации

2. НЕПОЛНАЯ РЕАЛИЗАЦИЯ ❌
   - 12 из 13 routes - заглушки
   - Только auth.js работает
   - Нет бизнес-логики
   - Нет интеграции с core/

3. HARDCODED VALUES ❌
   - IP адрес: 10.228.141.81
   - Auth URL: exp://10.228.141.81:8081
   - Не работает в production

4. RATE LIMITING ❌
   - In-memory (не масштабируется)
   - Redis отключен
   - Потеряется при рестарте
   - Не работает в кластере

5. WEBSOCKET ❌
   - Нет аутентификации
   - Минимальная логика
   - global.broadcastToRoom
   - Нет room management
   - Нет reconnection

═══════════════════════════════════════════════════════════════════

🔄 СРАВНЕНИЕ: src/ vs core/
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

lambda/src/ (Express):
- JavaScript
- Express сервер
- Монолитная архитектура
- WebSocket встроен
- 13 routes (12 заглушек)
- 2 репозитория
- In-memory rate limiting
- Для локальной разработки

lambda/core/ (Lambda):
- TypeScript
- AWS Lambda функции
- Serverless архитектура
- WebSocket отдельно
- ~50+ функций (полная реализация)
- ~20+ репозиториев
- DynamoDB, S3, SNS, SES
- Для production

ВЫВОД: core/ - это production код, src/ - legacy/dev сервер

═══════════════════════════════════════════════════════════════════

💡 РЕКОМЕНДАЦИИ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ВАРИАНТ 1: УДАЛИТЬ src/ ✅ (РЕКОМЕНДУЕТСЯ)
   Причины:
   - core/ полностью реализован
   - src/ - только заглушки
   - Дублирование кода
   - Сложность поддержки
   - Production использует core/
   
   Действия:
   1. Удалить lambda/src/
   2. Обновить package.json scripts
   3. Использовать только core/
   4. Для локальной разработки - AWS SAM Local

ВАРИАНТ 2: СИНХРОНИЗИРОВАТЬ ⚠️ (НЕ РЕКОМЕНДУЕТСЯ)
   Причины:
   - Много работы
   - Риск ошибок
   - Двойная поддержка
   - Разные языки
   
   Действия:
   1. Реализовать все 12 routes
   2. Портировать логику из core/
   3. Добавить TypeScript
   4. Настроить Redis
   5. Исправить WebSocket
   6. Убрать hardcoded values

ВАРИАНТ 3: ИСПОЛЬЗОВАТЬ src/ ДЛЯ DEV ⚠️
   Причины:
   - Быстрый старт для разработки
   - Не нужен AWS
   - Проще дебаг
   
   Действия:
   1. Оставить как есть
   2. Документировать что это dev-only
   3. Реализовать proxy к core/
   4. Не использовать в production

═══════════════════════════════════════════════════════════════════

🎯 ПЛАН ДЕЙСТВИЙ (ВАРИАНТ 1):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. BACKUP ✅
   - Сохранить src/ в архив (на случай)
   - Закоммитить текущее состояние

2. УДАЛИТЬ src/ ✅
   - Удалить lambda/src/
   - Обновить package.json:
     - Удалить "start": "node src/server.js"
     - Удалить "dev": "nodemon src/server.js"
   - Обновить .gitignore если нужно

3. НАСТРОИТЬ ЛОКАЛЬНУЮ РАЗРАБОТКУ ✅
   - Использовать AWS SAM Local
   - Или создать простой dev proxy
   - Документировать процесс

4. ОБНОВИТЬ ДОКУМЕНТАЦИЮ ✅
   - README.md
   - Deployment guide
   - Development guide

5. ТЕСТИРОВАНИЕ ✅
   - Проверить что core/ работает
   - Проверить Lambda функции
   - Проверить API endpoints

═══════════════════════════════════════════════════════════════════

📊 СТАТИСТИКА src/:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Файлов:              17
Строк кода:          ~1500
Реализовано:         ~10% (только auth)
Заглушек:            12 routes
Дублирует core/:     Да
Используется:        Только для dev
Production ready:    Нет

═══════════════════════════════════════════════════════════════════

✅ ИТОГОВАЯ РЕКОМЕНДАЦИЯ:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

УДАЛИТЬ lambda/src/

Причины:
1. Дублирует core/ (production код)
2. 92% заглушек (12 из 13 routes)
3. Разные языки (JS vs TS)
4. Hardcoded values
5. In-memory rate limiting
6. Не масштабируется
7. Сложность поддержки
8. Production использует core/

Альтернатива для dev:
- AWS SAM Local
- Serverless Offline
- Простой proxy к Lambda

═══════════════════════════════════════════════════════════════════

СТАТУС: ⚠️ ТРЕБУЕТСЯ РЕШЕНИЕ

Выбери вариант:
1. Удалить src/ (рекомендуется)
2. Синхронизировать с core/ (много работы)
3. Оставить для dev (документировать)

═══════════════════════════════════════════════════════════════════
