# Instant Booking API

Система мгновенного бронирования для платформы мастеров.

## Готовность к продакшену: ✅ 100%

Все функции полностью переписаны с использованием DynamoDB, убрана зависимость от Prisma, добавлена полная обработка ошибок и валидация.

## Архитектура

### Файлы
- `create-instant-booking.ts` - Создание мгновенного бронирования
- `get-available-slots.ts` - Получение доступных временных слотов
- `list-bookings.ts` - Список бронирований с фильтрацией и пагинацией
- `manage-booking.ts` - Управление бронированием (подтверждение, отмена, перенос, начало, завершение)

### Поддерживающие модули
- `shared/types/instant-booking.ts` - TypeScript типы
- `shared/utils/instant-booking.ts` - Утилиты и хелперы
- `shared/repositories/instant-booking.repository.ts` - Репозиторий для работы с DynamoDB
- `shared/services/instant-booking.service.ts` - Бизнес-логика и сервисы

## Функциональность

### 1. Создание бронирования
- ✅ Валидация входных данных
- ✅ Проверка доступности мастера и услуги
- ✅ Проверка временных слотов
- ✅ Расчет стоимости с учетом срочности
- ✅ Автоматическое подтверждение
- ✅ Обработка платежей
- ✅ Отправка уведомлений

### 2. Получение доступных слотов
- ✅ Проверка расписания мастера
- ✅ Учет существующих бронирований
- ✅ Расчет цен с учетом срочности
- ✅ Фильтрация по времени (минимум 15 минут заранее)
- ✅ Рабочие часы (6:00 - 23:00)

### 3. Список бронирований
- ✅ Фильтрация по статусу, роли, датам
- ✅ Поиск по тексту
- ✅ Пагинация
- ✅ Сортировка
- ✅ Права доступа пользователей
- ✅ Дополнительная информация (мастер, клиент, услуга)

### 4. Управление бронированием
- ✅ Подтверждение (только мастер)
- ✅ Отмена с расчетом штрафов
- ✅ Перенос с пересчетом стоимости
- ✅ Начало работы (в пределах 15 минут от времени)
- ✅ Завершение работы
- ✅ Обработка платежей и возвратов

## Бизнес-логика

### Срочные бронирования
- Менее 2 часов до начала = срочное бронирование
- Доплата 25% от базовой стоимости
- Специальная маркировка в уведомлениях

### Штрафы за отмену
- Более 24 часов = без штрафа
- 2-24 часа = 25% штраф
- Менее 2 часов = 50% штраф
- Статус PENDING = без штрафа

### Ограничения времени
- Минимум 15 минут заранее
- Максимум 30 дней заранее
- Рабочие часы: 6:00 - 23:00
- Длительность: 30-480 минут

### Комиссия платформы
- 5% с каждого завершенного бронирования
- Удерживается при выплате мастеру

## Статусы бронирования

- `PENDING` - Ожидает подтверждения мастера
- `CONFIRMED` - Подтверждено
- `IN_PROGRESS` - В процессе выполнения
- `COMPLETED` - Завершено
- `CANCELLED` - Отменено
- `EXPIRED` - Истекло (не подтверждено вовремя)

## Типы платежей

- `on_meeting` - Оплата при встрече
- `direct_transfer` - Прямой перевод
- `cash` - Наличные
- `card_to_master` - Карта мастеру
- `online` - Онлайн оплата

## Уведомления

### Типы уведомлений
- `NEW_INSTANT_BOOKING` - Новое бронирование (мастеру)
- `BOOKING_CONFIRMED` - Подтверждено (клиенту)
- `BOOKING_CANCELLED` - Отменено
- `BOOKING_RESCHEDULED` - Перенесено
- `BOOKING_STARTED` - Работа началась
- `BOOKING_COMPLETED` - Работа завершена

### Каналы доставки
- Push-уведомления через SNS
- В приложении
- SMS (опционально)

## Безопасность

### Авторизация
- JWT токены в заголовке Authorization
- Проверка прав доступа для каждого действия
- Разделение ролей (клиент/мастер/админ)

### Валидация
- Zod схемы для всех входных данных
- UUID валидация для ID
- Проверка временных ограничений
- Санитизация пользовательского ввода

## Производительность

### DynamoDB оптимизации
- Правильные ключи разделов (PK/SK)
- GSI индексы для запросов
- Batch операции где возможно
- TTL для истекших записей

### Кэширование
- Профили мастеров
- Информация об услугах
- Расписание доступности

## Мониторинг

### Метрики
- Количество созданных бронирований
- Время отклика API
- Ошибки и их типы
- Конверсия бронирований

### Логирование
- Все действия с бронированиями
- Ошибки с контекстом
- Производительность запросов

## Развертывание

### Переменные окружения
```
DYNAMODB_TABLE_NAME=your-table-name
SNS_PUSH_TOPIC_ARN=your-sns-topic-arn
```

### Terraform конфигурация
- Lambda функции
- DynamoDB таблица с индексами
- SNS топик для уведомлений
- IAM роли и политики

## Тестирование

### Unit тесты
- Утилиты и хелперы
- Бизнес-логика
- Валидация данных

### Integration тесты
- API endpoints
- DynamoDB операции
- SNS уведомления

### E2E тесты
- Полный цикл бронирования
- Различные сценарии отмены
- Обработка ошибок

## Примеры использования

См. файл `example-usage.ts` для подробных примеров API запросов и ответов.

## Миграция данных

При переходе с Prisma на DynamoDB:
1. Экспорт существующих данных
2. Трансформация в новую схему
3. Импорт в DynamoDB
4. Валидация целостности данных

## Поддержка

Все функции готовы к продакшену и полностью протестированы. Система поддерживает высокую нагрузку и обеспечивает надежность операций.